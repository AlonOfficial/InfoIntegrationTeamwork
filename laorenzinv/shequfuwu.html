<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8" />
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>老人子女入口</title>
  <script src="../js/jquery-3.5.1.min.js"></script>


</head>


<body>

  <style>


  </style>


  <h1>告诉我们您的需要</h1>
  <input type="button" id="lifa" style="font-size: 50px;" value="理发" onclick="qingqiu()"></input>
  <input type="button" id="songcan" style="font-size: 50px;" value="送餐" onclick="qingqiu()"></input>
  <input type="button" id="jiuyi" style="font-size: 50px;" value="陪同就医" onclick="qingqiu()"></input>
  <input type="button" id="huli" style="font-size: 50px;" value="护理" onclick="qingqiu()"></input>
  <input type="button" id="jiazheng" style="font-size: 50px;" value="家政" onclick="qingqiu()"></input>
  <input type="button" id="zuoche" style="font-size: 50px;" value="坐车" onclick="qingqiu()"></input>
  <input type="button" id="weixiu" style="font-size: 50px;" value="维修" onclick="qingqiu()"></input>
  


  <script>
    var mname;
    
    var id = parseInt(sessionStorage.getItem("id"));
    
    //$("input").click(function (e) {
    $("input").off("click").on("click", function (e) {
      mid = $(e.target).attr("id");
      mname = document.getElementById(mid).value;
    });

    
    var db;
    var indexedDB = window.indexedDB;
    //var db;
    if (!indexedDB) {
      window.alert("你的浏览器不支持IndexedDB");
    }
    //打开数据库
    var request = window.indexedDB.open("yanglao", 1);
    request.onerror = function (event) {
      console.log('数据库打开报错');
    };
    request.onupgradeneeded = function (event) {
      db = event.target.result;
      console.log("版本变化");

    }

    request.onsuccess = function (event) {
      db = event.target.result;

    }



    //向服务器发送请求
    //qingqiu  = function(){
    function qingqiu() {





      //判断老人在社区还是养老院
      var name = "";

      var res1 = db.transaction(['hukou'], 'readonly').objectStore('hukou').get(id);
      res1.onerror = function (event) {
        console.log('事务失败');
      };

      res1.onsuccess = function (event) {
        console.log("拿到老人数据");
        name = res1.result.name;
        //判断老人在社区还是养老院
        var res2 = db.transaction(['shequlaoren'], 'readonly').objectStore('shequlaoren')
              .get(id);
            res2.onerror = function (event) {
              console.log('读入失败');
            };
            res2.onsuccess = function (event) {
              if(event.target.result){
                //社区
                console.log("进入社区循环");
                //获取老人对应社区的sid
                var sid = res2.result.sid;
                var res3 = db.transaction(['shequqingqiu'], 'readwrite').objectStore('shequqingqiu').add({ sid: sid, id: id, name: name, leixing: mname, isok: 0 });
                res3.onerror = function (event) {
                  console.log('写入失败');
                };
                res3.onsuccess = function (event) {
                  console.log('写入成功');
                }
                alert("您当前居住于社区中，我们已联系社区志愿者尽快帮您" + mname);

              }else{
                var res4 = db.transaction(['yanglaoyuanlaoren'], 'readonly').objectStore('yanglaoyuanlaoren')
                      .get(id);
                     res4.onerror = function (event) {
                      console.log('读入失败');
                     };
                     res4.onsuccess = function (event) {
                       if(event.target.result){
                           //养老院 
                          console.log("进入养老院循环");
                          var yid = res4.result.yid;
                          var res5 = db.transaction(['yanglaoyuanqingqiu'], 'readwrite').objectStore('yanglaoyuanqingqiu').add({ yid: yid, id: id, name: name, leixing: mname, isok: 0 });
                          res5.onerror = function (event) {
                            console.log('写入失败');
                          };
                          res5.onsuccess = function (event) {
                            console.log('写入成功');

                          };
                          alert("您当前居住于养老院中，我们已联系养老院尽快帮您" + mname);


                       }else{
                         //都不在
                         alert("抱歉您无法使用服务，建议您加入社区或养老院！");
                       }

                   
                     }

              }
            }
          }

         
      console.log('数据库打开成功');
    }






  </script>


</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8" />
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <title>社区入口</title>
    <script src="../js/jquery-3.5.1.min.js"></script>
    <script src="../js/our.js"></script>

<style>
table,tr,th,td
{
    text-align:middle;
    font-size: 20px;
    height:40px;
    border: 1px solid black;
}    
</style>
</head>
<!-- <div id="tiaoxingtu" style="width: 600px;height:500px;"></div>
<div id="shanxingtu" style="width: 600px;height:500px;"></div> -->


<body>
    <h1 style="text-align: center;" >以下为社区内老人</h1>
    <table id="tableEntry">
        <tr>
            <th>id</th>
            <th>姓名</th>
            <th>性别</th>
            <th>年龄</th>
            <th>婚姻情况</th>
            <th>住址</th>
            <th>同住子女</th>
            <th>同住配偶</th>
            <th>同住他人</th>
            <th>操作</th>
        </tr>
    
    </table>
    <script>
        var sid = parseInt(sessionStorage.getItem("sid"));
        console.log(sid);

        //
        var indexedDB = window.indexedDB;


        //打开社区老人库
        var db;
        var request1 = window.indexedDB.open("yanglao", 1);
        request1.onsuccess = function (event) {
            db = event.target.result;
            console.log('数据库打开成功');
            readandshow();
        }
        request1.onupgradeneeded = function (event) {
            db = event.target.result;
            console.log("版本变化");
        }






        //读取老人数据以表格形式表现
        function readandshow() {
            //核心遍历查找语句，使用了index与cursor遍历
            var request = db.transaction('shequlaoren', "readonly").objectStore('shequlaoren').index('sid').openCursor(sid);
            var dataList = new Array();
            var i = 0;
            request.onerror = function (event) {
                console.log('事务失败');
            };

            request.onsuccess = function (event) {
                var cursor = event.target.result;

                if (cursor) {
                    var tableRow = document.createElement('tr');

                    var request1 = db.transaction('hukou', "readonly").objectStore('hukou').get(cursor.value.id);
                    request1.onerror = function (event) {
                        console.log('事务失败');
                    };

                    request1.onsuccess = function (event) {
                        result = event.target.result;
                        tableRow.id = result.id;
                        tableRow.innerHTML = '<td>' + result.id + '</td>'
                            + '<td>' + result.name + '</td>'
                            + '<td>' + result.gender + '</td>'
                            + '<td>' + GetAge(result.birthday) + '</td>'
                            + '<td>' + result.marriage + '</td>'
                            + '<td>' + result.address + '</td>'
                            + '<td>' + cursor.value.children + '</td>'
                            + '<td>' + cursor.value.spouse + '</td>'
                            + '<td>' + cursor.value.others + '</td>'
                            + '<td style = "color:red" onclick = deleteID(' + result.id + ')>' + '删除' + '</td>';


                        tableEntry.appendChild(tableRow);

                    }
                    console.log(cursor);
                    cursor.continue();
                }


                // if (request.result) {
                //     data = event.target.result;

                //     console.log(data);
                //     data.continue();
                //     console.log(data);
                //     data = event.target.result;
                //     console.log(data);

                //     // var cursor = request.result;

                //     // if (cursor) {
                //     //     console.log(cursor.key);
                //     //     dataList[i] = cursor.value;
                //     //     console.log(dataList[i].id);
                //     //     i++;
                //     //     cursor.continue();
                //     // }

                //     // console.log('name: ' + result.sname);
                //     // $(document).ready(function () {
                //     //     //基本信息
                //     //     $("#01").text("姓名：" + result.sname + "       " + "地址：" + result.saddress);
                //     //     $("#02").text("管理员: " + result.smanager + "      " + "电话：" + result.scontactnum);
                //     //     $("#03").text("员工数: " + result.sworkernum);


                //     // });

                // } else {
                //     console.log('未获得数据记录');
                // }
            };
        }
        function deleteID(id) {
            document.getElementById(id).remove();

            var request = db.transaction('shequlaoren', "readwrite").objectStore('shequlaoren').delete(id);
            request.onerror = function (event) {
                console.log('事务失败');
            };

            request.onsuccess = function (event) {
                window.alert('删除成功');
            }
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8"/>
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <title>社区入口</title>
    <script src="../js/jquery-3.5.1.min.js"></script>

    
</head>


<body>
    <div id="tableEntry">

    </div>
    <script>
    var sid = parseInt(sessionStorage.getItem("sid"));
    console.log(sid);

    tableEntry.innerHTML = '';
    var indexedDB = window.indexedDB;


    //打开社区老人库
    var db;
    var request1 = window.indexedDB.open("yanglao", 1);
    request1.onsuccess = function (event) {
        db = event.target.result;
        console.log('数据库打开成功');
        readandshow();
    }
    request1.onupgradeneeded = function (event) {
        db = event.target.result;
        console.log("版本变化");
    }



    //读取老人请求数据
    function readandshow() {
        //核心遍历查找语句，使用了index与cursor遍历
        var request = db.transaction('shequqingqiu', "readonly").objectStore('shequqingqiu').index('sid').openCursor(sid);
        var dataList = new Array();
        var i = 0;
        request.onerror = function (event) {
            console.log('事务失败');
        };

        request.onsuccess = function (event) {
            var cursor = event.target.result;
            
            if (cursor) {
                var tableRow = document.createElement('div');
                
                var request1 = db.transaction('hukou', "readonly").objectStore('hukou').get(cursor.value.id);
                request1.onerror = function (event) {
                    console.log('事务失败');
                };

                request1.onsuccess = function (event) {
                    result = event.target.result;
                    tableRow.id = result.id;
                    tableRow.innerHTML = 
                    '<td>' + result.id + '</td>'
                    + '<td>' + result.name + '</td>'
                    + '<td>' + result.gender + '</td>'
                    + '<td>' + result.birthday + '</td>'
                    + '<td>' + result.marriage + '</td>'
                    + '<td>' + result.address + '</td>'
                    + '<td>' + cursor.value.children + '</td>'
                    + '<td>' + cursor.value.spouse + '</td>'
                    + '<td>' + cursor.value.others + '</td>'
                    + '<input type="submit" value="删除" onclick=deleteID('+result.id+') >';

                    tableEntry.appendChild(tableRow);

                }
                console.log(cursor);
                cursor.continue();
            }
            

            // if (request.result) {
            //     data = event.target.result;

            //     console.log(data);
            //     data.continue();
            //     console.log(data);
            //     data = event.target.result;
            //     console.log(data);

            //     // var cursor = request.result;

            //     // if (cursor) {
            //     //     console.log(cursor.key);
            //     //     dataList[i] = cursor.value;
            //     //     console.log(dataList[i].id);
            //     //     i++;
            //     //     cursor.continue();
            //     // }

            //     // console.log('name: ' + result.sname);
            //     // $(document).ready(function () {
            //     //     //基本信息
            //     //     $("#01").text("姓名：" + result.sname + "       " + "地址：" + result.saddress);
            //     //     $("#02").text("管理员: " + result.smanager + "      " + "电话：" + result.scontactnum);
            //     //     $("#03").text("员工数: " + result.sworkernum);


            //     // });

            // } else {
            //     console.log('未获得数据记录');
            // }
        };
    }
    function deleteID(id)
    {
        document.getElementById(id).remove();

        var request = db.transaction('shequlaoren', "readwrite").objectStore('shequlaoren').delete(id);
        request.onerror = function (event) {
            console.log('事务失败');
        };

        request.onsuccess = function (event) {
            console.log('删除成功');
        }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8"/>
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <title>民政局入口</title>
    <script src="../js/jquery-3.5.1.min.js"></script>
    <script src="../js/echarts.common.js"></script>
    <link rel="stylesheet" href="num.css">

    
</head>


<body>
    <!-- <div style="width: 100%; height: 50px; text-align: center;">shourutu</div>
    <div class="counter col_fourth">
        <p class="count-text ">全市65岁以上老人数</p>
    </div> -->
        <!-- <div id="num" style="width: 50%; height: 50px; color:grey; float:left">全市65岁以上老人数</div>
    <div id="rate" style="width: 50%; height: 50px; color:grey; float: left;">全市老龄化比例</div> -->
    <div>
        <div id='AgeSexGragh' style="width: 50%; height: 400px; float: left;"></div>
        <div id='BingGragh' style="width: 50%; height: 400px; float: right;"></div>
    </div>
    <div>别重合了求你了</div>


<script>
    //open db
    var request = window.indexedDB.open("yanglao", 1);
    request.onerror = function (event){
        console.log('open db error');
    };

    //open db success
    request.onsuccess = function(event){
        db = event.target.result;
        showAgeSexGragh();
        shwoBingGragh();
        //main
    }

    //show age and sexual gragh
    function showAgeSexGragh(){
        var res = db.transaction('hukou').objectStore('hukou');
        // res.onerror = function(event){
        //     console.log('read data false');
        // };
        var maleData=[0,0,0,0,0];
        var femaleData=[0,0,0,0,0];
        console.log("done!");
        res.openCursor().onsuccess = function(event){ //cursor循环会从这里开始
            var cursor = event.target.result;
            var tempAge;
            //analyse data
            if(cursor){
                console.log(cursor.value.id);
                tempAge = GetAge(cursor.value.birthday);
                var i=0;
                if(tempAge<=60){
                    i=0;
                }
                else if(tempAge<=65){
                    i=1;
                }
                else if(tempAge<=70){
                    i=2;
                }
                else if(tempAge<=75){
                    i=3;
                }
                else{
                    i=4;
                }              
                if(cursor.value.gender == "男"){
                    maleData[i] += 1;
                }
                else{
                    femaleData[i] += 1;
                }
                console.log(maleData);
                cursor.continue();
            }        
            else{
                //set optipn
                var option = {
                    title: {
                        text: '老人年龄分布图'
                    },
                    tooltip:{
                        triger:'axis',
                        axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    legend: {
                        data: ['男', '女']
                    },
                    grid: {
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    yAxis: [
                        {
                            type: 'category',
                            axisTick: {
                                show: false
                            },
                            data: ['<60', '60-65', '65-70', '70-75', '75<']
                        }
                    ],
                    series: [
                        {
                            name: '男',
                            type: 'bar',
                            label: {
                                show: true,
                                position: 'inside'
                            },
                            data: maleData
                        },
                        {
                            name: '女',
                            type: 'bar',
                            label: {
                                show: true
                            },
                            data: femaleData
                        }
                    ]
                };
                var mychart = echarts.init(document.getElementById('AgeSexGragh'));
                mychart.setOption(option);
            }           
        }
    }
    //show ill and count
    function shwoBingGragh(){
        var bingC = echarts.init(document.getElementById('BingGragh'));
        var res = db.transaction('bingli').objectStore('bingli');
        var bing=[];
        var num=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
        var mydata=[];
        var index=0;
        res.openCursor().onsuccess = function(event){
            console.log('done');
            var cursor = event.target.result;
            if(cursor){
                var tBing = cursor.value.ill;
                if(bing.indexOf(tBing) === -1){
                    bing.push(tBing);
                }
                index = bing.indexOf(tBing);
                num[index] += 1;
                console.log(num);
                cursor.continue();
            }
            else{
                console.log(bing);
                for(var i=0;i<bing.length;i++){
                    mydata.push({value:num[i], name:bing[i]});
                }
                console.log(mydata);
                var option = {
                    title: {
                        text: '老龄人常见疾病统计',
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b} : {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        top:'50px',
                        data: bing,
                    },
                    series: [
                        {
                            name: '患病人数',
                            type: 'pie',
                            radius: '55%',
                            center: ['50%', '60%'],
                            data: mydata,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                bingC.setOption(option);     
            }
        }
    } 
    //get age by birthday
    function GetAge(strBirthday){         
        var returnAge;  
        var strBirthdayArr=strBirthday.split("-");  
        var birthYear = strBirthdayArr[0];  
        var birthMonth = strBirthdayArr[1];  
        var birthDay = strBirthdayArr[2];  
        
        d = new Date();  
        var nowYear = d.getFullYear();  
        var nowMonth = d.getMonth() + 1;  
        var nowDay = d.getDate();  
        
        if(nowYear == birthYear){  
            returnAge = 0;//同年 则为0岁  
        }  
        else{  
            var ageDiff = nowYear - birthYear ; //年之差  
            if(ageDiff > 0){  
                if(nowMonth == birthMonth) {  
                    var dayDiff = nowDay - birthDay;//日之差  
                    if(dayDiff < 0)  
                    {  
                        returnAge = ageDiff - 1;  
                    }  
                    else  
                    {  
                        returnAge = ageDiff ;  
                    }  
                }  
                else  
                {  
                    var monthDiff = nowMonth - birthMonth;//月之差  
                    if(monthDiff < 0)  
                    {  
                        returnAge = ageDiff - 1;  
                    }  
                    else  
                    {  
                        returnAge = ageDiff ;  
                    }  
                }  
            }  
            else  
            {  
                returnAge = -1;//返回-1 表示出生日期输入错误 晚于今天  
            }  
        }  
        return returnAge;//返回周岁年龄  
    }  
</script>

</body>
</html>
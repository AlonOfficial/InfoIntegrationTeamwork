
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>查看请求</title>
    <script src = '../../js/jquery-3.5.1.min.js'></script>
    <script src = '../../js/jquery-3.5.1.min.js'></script>
    <style>
        .d{
            /*color: red;*/
            display: none;
        }
    </style>
</head>
<body>
<h>test</h>
<div class="show-request" id="request-result">
    <table id="older-request" class="request-table"></table>
</div>

<script>
    var NursingId = parseInt(sessionStorage.getItem("yid"));


    var olderNursinglist = new Array();
    //向服务器发送请求
    var indexedDB = window.indexedDB;
    var db;
    if (!indexedDB) {
        window.alert("你的浏览器不支持IndexedDB");
    }


    //打开数据库
    var request = window.indexedDB.open("yanglao", 1);
    request.onerror = function (event) {
        console.log('数据库打开报错');
    };
    request.onupgradeneeded = function (e) {
        db = event.target.result;
        console.log("版本变化");

    }
    request.onsuccess = function (event) {
        db = event.target.result;
    }


    //读取老人数据以表格形式表现
    function readandshow(id) {
        var arr=new Array();
        var res = db.transaction(['hukou'], 'readwrite').objectStore('hukou').get(id);
        res.onerror = function (event) {
            console.log('事务失败');
        };
        res.onsuccess = function (event) {
            if (res.result) {
                arr.push(res.result.name);
                arr.push(res.result.gender);
                arr.push(res.result.birthday);
            }
        }
        return arr;
    }

    function showData() {
        var store = db.transaction(['shenqingyly'], 'readonly').objectStore('shenqingyly');
        var c = store.openCursor();//打开游标
        c.onsuccess = function (e) {//成功执行回调
            var cursor = e.target.result;
            if (cursor) {//如果存在
                var older = cursor.value;
                if (older.yid == NursingId) {
                    olderNursinglist.push(older);
                    var id = older.id;
                    // var res = db.transaction(['hukou'], 'readwrite').objectStore('hukou').get(id);
                    // res.onerror = function (event) {
                    //     console.log('事务失败');
                    // };
                    // res.onsuccess = function (event) {
                    //     if (res.result) {
                    //         arr.push(res.result.name);
                    //         arr.push(res.result.gender);
                    //         arr.push(res.result.birthday);
                    //     }
                    // }

                    // var name = arr[1];
                    // alert(name)
                    // var gender = older.gender;
                    // var birthday = older.birthday;
                    // var bedid = older.bedid;
                    var html = "";
                    html += '<tr>';
                    html += '<th> Id</th>' + '<td>' + id + '</td>';
                    // html += '<th> Name</th>' + '<td>' + name + '</td>';
                    // html += '<th> gender</th>' + '<td>' + gender + '</td>';
                    // html += '<th> birthday</th>' + '<td>' + birthday + '</td>';
                    // html += '<th> bedid</th>' + '<td>' + bedid + '</td>';
                    html += '<td><input type="button" id="delete" value="删除"> </input></td>'
                    html += '<td><input type="button" id="confirm" value="确认"> </input></td>'
                    html += '</tr>';
                    $("#older-request").append(html);
                }
                cursor.continue();//继续下一个
            }


        }
    }

    setTimeout(() => {
        showData();
    }, 500);

</script>

<script>

    $(document).on('click', '#delete', function () {
        var id =$(this).parent().siblings().eq(1).text();
        var request = db.transaction('shenqingyly', "readwrite").objectStore('shenqingyly').openCursor()
        request.onerror = function (event) {
            console.log('事务失败');
        };
        request.onsuccess = function (event) {
            var cursor = event.target.result;
            if (cursor) {
                var older = cursor.value;
                alert(older.id==id)
                if (older.id == id) {
                    cursor.delete();
                    console.log('删除成功');
                }
            }
            cursor.continue();
        }
        $(this).parent().parent().remove();
    });

    $(document).on('click', '#confirm', function () {
        $(this).addClass('d');
        var text =[];
        $(this).parent().parent().children('td').each(function(j){  // 遍历 tr 的各个 td
            text.push($(this).html());
        });

        var id = text[0];
        var name =text[1];
        var gender = text[2];
        var birthday =text[3];
    });


</script>
</body>
</html>
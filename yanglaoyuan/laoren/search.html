<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../../js/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="search-menu">
    <th class="search-item">姓名</th>
    <input class="item" id="vname"></input>
    <th class="search-item">性别</th>
    <input class="item" id="vgender"> </input>
    <th class="search-item">年龄段</th>
    <input id="txt_1" list="datalist_1"/>
    <datalist id="datalist_1">
        <option value="<60" data-id="<60">
        <option value="60-70" data-id="60-70">
        <option value="70-80" data-id="70-80">
        <option value="80-90" data-id ="80-90">
        <option value=">90" data-id =">90">
    </datalist>
<button onclick="MatchSearch()">搜索</button>
</div>
<div class="show-searchIno" id="search-result">
    <table id="older-searchInfo" class="search-table"></table>
</div>

<script>
    var NursingId = parseInt(sessionStorage.getItem("yid"));
    var olderNursinglist = new Array();
    //向服务器发送请求
    searchInfo_odler_request();
    function searchInfo_odler_request() {
        var indexedDB = window.indexedDB;
        var db;
        if (!indexedDB) {
            window.alert("你的浏览器不支持IndexedDB");
        }

        //打开数据库
        var request = window.indexedDB.open("yanglao", 1);
        request.onerror = function (event) {
            console.log('数据库打开报错');
        };
        request.onupgradeneeded = function (e) {
            db = event.target.result;
            console.log("版本变化");

        }
        request.onsuccess = function (event) {
            db = event.target.result;
            var store = db.transaction(['yanglaoyuanlaoren'], 'readonly').objectStore('yanglaoyuanlaoren');
            var c = store.openCursor();//打开游标
            c.onsuccess = function (e) {//成功执行回调
                var cursor = e.target.result;
                if (cursor) {//如果存在
                    var older = cursor.value;
                    if (older.yid == NursingId) {
                        olderNursinglist.push(older);
                        var name = older.name;
                        var gender = older.gender;
                        var birthday = older.birthday;
                        var bedid = older.bedid;
                        var html = "";
                        html += '<tr>';
                        html += '<th> Name</th>' + '<td>' + name + '</td>';
                        html += '<th> gender</th>' + '<td>' + gender + '</td>';
                        html += '<th> birthday</th>' + '<td>' + birthday + '</td>';
                        html += '<th> bedid</th>' + '<td>' + bedid + '</td>';
                        html += '<tr>';
                        html += '</tr>';
                        $("#older-searchInfo").append(html);
                    }
                    cursor.continue();//继续下一个
                }


            }
        }
    }

    function MatchSearch() {
        var vname = $("#vname").val();
        var vgender = $('#vgender').val();
        var vage;

        var $options=$("#datalist_1").children();
        for(var i=0;i<$options.length;i++){
            if($options.eq(i).val().trim()==$("#txt_1").val().trim()){
                vage = $options.eq(i).attr("data-id");
                break;
            }else{
                vage = $("#txt_1").val();
            }
        }

        var arr = new Array(olderNursinglist.length);
        for (var j = 0; j < olderNursinglist.length; j++) {
            arr[j] = 1;
        }

        // var searchInfolist = new Array();
        //姓名匹配搜索
        if (vname ==""){
        }else{
        if (vname.length != 0) {
            for (var j = 0, len = olderNursinglist.length; j < len; j++) {
                var older = olderNursinglist[j];
                if (older.name.indexOf(vname)== -1) {
                    arr[j] = 0;
                }
            }
        }
        }

       if(vgender==""){}else {
           if (vgender.length != 0) {
               for (var j = 0, len = olderNursinglist.length; j < len; j++) {
                   var older = olderNursinglist[j];
                   if (older.gender != vgender) {
                       arr[j] = 0;
                   }
               }
           }
       }


       if(vage==''){}
       else {
           // 年龄段判断
           for (var j = 0, len = olderNursinglist.length; j < len; j++) {
               var older = olderNursinglist[j];
               var ages = parseInt(new Date().getFullYear() - new Date(older.birthday).getFullYear());
               if (vage == '<60') {
                   if (ages > 60) {
                       arr[j] = 0;
                   }
               } else if (vage == '60-70') {
                   if (ages >= 70 || ages < 60) {
                       arr[j] = 0;
                   }
               } else if (vage == '70-80') {
                   if (ages >= 80 || ages < 70) {
                       arr[j] = 0;
                   }
               } else if (vage == '80-90') {
                   if (ages >= 90 || ages < 80) {
                       arr[j] = 0;
                   }
               } else if (vage == '>90') {
                   if (ages < 90) {
                       arr[j] = 0;
                   }
               } else if (!isNaN(Number(vage))) {
                   if (ages != Number(vage)) {
                       arr[j] = 0;
                   }
               } else {
               }
           }
       }

        //最终结果显示
        var html = "";
        for (var j = 0, len = olderNursinglist.length; j < len; j++) {
            console.log(arr[j]);
            if (arr[j] == 1) {
                var olderInfo = olderNursinglist[j];
                html += "<tr>"
                html += '<th> Name</th>' + '<td>' + olderInfo.name + '</td>';
                html += '<th> gender</th>' + '<td>' + olderInfo.gender + '</td>';
                html += '<th> birthday</th>' + '<td>' + olderInfo.birthday + '</td>';
                html += '<th> bedid</th>' + '<td>' + olderInfo.bedid + '</td>';
                html += '<tr>';
            }
        }
        $("#older-searchInfo").empty().append(html);
        console.log(typeof (vname), typeof (gender), typeof (age));
        console.log(vname.length);
        vgender = $("vgender"),
            vage = $("age-group");
        for (var j = 0, len = olderNursinglist.length; j < len; j++) {
            console.log(olderNursinglist[j]);
        }
    }

</script>


</body>
</html>
